!function(t,e){"use strict";t.fn.datagrid=function(e){var r=t.type(e);if("string"===r)return this.each(function(){var r=t(this).data("ui");if(!r||!r.iDatagrid)throw new Error("UI:datagrid does not init...");r.iDatagrid[e]()}),!0;e=t.extend(!0,{colWidth:80,startRowNum:1,data:[]},e);var n=function(t,e){return new n.prototype.init(t,e)},i=light.ui.markChars,a=light.util.push,o=(light.util.toString,light.util.getType),d=light.util.createElement,s=function(t,e){var r=function(r,n){var a=[],o=n?"frozenColumns":"columns";if(!r)return a;for(var s=r.length-1,l=s;l>=0;l--)a.unshift(d({name:"tr",children:function(){for(var a=[],h=r[l].length-1;h>=0;h--){var c=r[l][h],u=c.name||c.field||"",f=t.autoColWidth||c.colspan?"auto":(c.width||t.colWidth)+"px",m={};c.rowspan&&(m.rowspan=c.rowspan),c.colspan&&(m.colspan=c.colspan);var p=c.colspan||1,v=1==p&&(l==s||r.length==l+(c.rowspan||1));v&&(e[o].unshift(c),m.className="field"),a.unshift(d({name:"td",attr:m,children:{name:"div",attr:{className:"cell",style:{width:f}},children:[i.empty,u,{name:"span",attr:{className:"sort-mark"},children:i.empty}]}}))}return n&&0==l&&t.rowNum&&a.unshift(d({name:"td",attr:{rowspan:t.frozenColumns.length,className:"field"},children:{name:"div",attr:{className:"cell"}}})),a}()}));return a},n=function(e,r,n){var i=[];return e.forEach(function(e,a){i.push(d({name:"tr",children:function(){var i=[];return t.rowNum&&n&&i.push(d({name:"td",children:{name:"div",attr:{className:"cell"},children:a+t.startRowNum}})),r&&r.forEach(function(r,n){if(!r)return!0;var a=r.field,s=e[a],l=r.formatter;i.push(d({name:"td",children:{name:"div",attr:{className:"cell",style:{width:t.autoColWidth?"auto":(r.width||t.colWidth)+"px"}},children:"Function"===o(l)?l(s,e,a):s}}))}),i}()}))}),i};return d({name:"div",attr:{className:"view-wrapper"+(t.autoRowHeight?" autoRowHeight":"")},children:[{name:"div",attr:{className:"view frozen"},children:[{name:"div",attr:{className:"head-wrapper"},children:{name:"table",attr:{className:"frozen head"},children:{name:"tbody",children:r(t.frozenColumns,!0)}}},{name:"div",attr:{className:"body-wrapper",style:"overflow:hidden;"},children:{name:"table",attr:{className:"frozen body"},children:{name:"tbody",children:n(t.data,e.frozenColumns,!0)}}}]},{name:"div",attr:{className:"view"},children:[{name:"div",attr:{style:"overflow:hidden"},children:{name:"div",attr:{className:"head-wrapper"},children:{name:"table",attr:{className:"head"},children:{name:"tbody",children:r(t.columns)}}}},{name:"div",attr:{className:"body-wrapper"},children:{name:"table",attr:{className:"body"},children:{name:"tbody",children:n(t.data,e.columns)}}}]}]})},l=function(e,r){return document.documentMode<7||/MSIE 6/.test(navigator.userAgent)?e["offset"+("width"==r?"Width":"Height")]:t(e)[r]()},h=function(e,r,n){var i="width"===n?"Width":"Height";t(e).each(function(e,a){var o=this["offset"+i],d=r[e]["offset"+i],s=d>o?d:o;t([this,r[e]])[n](s)})},c=function(e,r,n){t.each(e,function(e,i){var a=n[e],o=l(this,r),d=l(a,r),s=d>o?d:o;t([this,a])[r](s+5)})},u=function(e,r){if(4==e.length){var n=e.eq(2).parent(),i=e.eq(3).parent();n.css({width:5e5}),i.css({width:5e5});var a=r.userOptions;(a.rowNum||a.frozenColumns)&&h(t([e[0],e[1]]),t([e[2],e[3]]),"height"),a.autoColWidth?c(e.filter("table:odd").find("tr:first-child td .cell"),"width",r.fieldElements):a.rowNum&&c(e.filter("table:odd").find("td .cell:first"),"width",r.fieldElements),(a.rowNum||a.frozenColumns)&&h(t([e[0],e[2]]),t([e[1],e[3]]),"width",r.fieldElements);var o="CSS1Compat"!==document.compatMode||/msie 6/i.test(navigator.userAgent)?"100%":"auto";i.css({width:o}),n.parent().css({width:o,overflow:"hidden"}),t(i).on("scroll",function(){n.parent().get(0).scrollLeft=this.scrollLeft,e.get(1).parentNode.scrollTop=this.scrollTop})}},f=function(t,e){var r,n=this.field;return t=t[n],e=e[n],this.order||(r=t,t=e,e=r),t==e?0:e>t?1:-1};return n.prototype={defaultOrder:!1,init:function(e,r){var n=t(e);n.addClass("datagrid-container cf");var i=this;if(this.columns=[],this.frozenColumns=[],this.userOptions=r,this.render=e,r.pagination&&r.localData){e.innerHTML='<div class="datagrid-pagination"></div>';var o=t(".datagrid-pagination",e).get(0);r.pagination.renders=[o],r.pagination.dataSize=r.localData.length,pagination(r.pagination);var d=o.ui.iPagination.userOptions;r.data=r.localData.slice((d.pageNumber-1)*d.pageSize,d.pageNumber*d.pageSize)}t(s(r,i)).prependTo(e),this.fieldElements=t(".field .cell",e),u(t("table",e),i),(5===document.documentMode||/MSIE 6/.test(navigator.userAgent))&&(t(".view",e).css({height:t(".head-wrapper").get(0).offsetHeight+t(".body-wrapper").get(0).offsetHeight}).eq(0).css({width:t(".view",e).eq(0).find("table").eq(0).width()}),t(".body-wrapper table, .body-wrapper table tr:first-child td",e).css({borderTop:"none"})),function(){var r=navigator.userAgent.match(/MSIE (\d*)/);r&&r[1]<9&&t(".view",e).eq(1).find("table, table td:first-child").css({borderLeft:"none"})}();var l=[];if(a.apply(l,this.frozenColumns),a.apply(l,this.columns),this.allColumns=l,this.dataTbodys=t(".body tbody",e),r.data[0].tr&&r.data[0].frozenTr||r.data.forEach(function(t,e){r.frozenColumns.length&&(t.frozenTr=i.dataTbodys[0].rows[e]),t.tr=i.dataTbodys[1].rows[e]}),r.remoteSort||r.sort)if(r.remoteSort){var h=function(){for(var t in i.allColumns)if(r.sort.field===i.allColumns[t].field)return t+1}();t(".sort-mark",this.fieldElements[h]).html(light.ui.markChars["desc"==r.sort.order?"down":"up"])}else this.sortBy(r.sort.field,"desc"===r.sort.order);this.init_event(),i.resize(),setTimeout(function(){i.resize()},0),r.onCreate.bind(this)()},init_event:function(){var e=this,r=this.userOptions,n=t(this.render);if(n.on({click:function(t){var n=e.fieldElements.index(this.children[0])-(r.rowNum?1:0);if(r.rowNum&&-1===n)return!1;var i=e.allColumns[n].field;e.sortBy(i,e.sort!==i?e.defaultOrder:!e.order)}},".field"),t(window).on("resize",function(){e.resize()}),5===document.documentMode||/MSIE 6/.test(navigator.userAgent)){var i={mouseenter:function(){this.style.backgroundColor="#e6e6e6"},mouseleave:function(){this.style.backgroundColor="transparent"}};n.on(i,".head td").on(i,".body tr")}},sortBy:function(e,r){r=-1!==[!0,"desc"].indexOf(r);var n,a=this.userOptions,o=this.allColumns.filter(function(t,r){return t.field===e?(n=r+1,!0):!1})[0],d=this.fieldElements[n].parentNode;if(this.sort&&t(".sort-mark",this.sort.parentNode).html(i.empty),t(".sort-mark",d).html(r?i.down:i.up),this.sort===d.field&&d.order===r)return!1;this.order=d.order=r,this.sort===o.field&&d.order===!this.defaultOrder?(this.sort=d.field=e,a.data=a.data.reverse()):(this.sort=d.field=e,a.data.sort((o.sort||f).bind({field:e,order:r})));var s=document.createDocumentFragment(),l=document.createDocumentFragment(),h=null,c=null;a.data.forEach(function(t,e){var r=t.frozenTr,n=t.tr;r&&(h||function(){h=r.parentNode,h.style.display="none"}(),s.appendChild(r),a.rowNum&&(r.children[0].children[0].innerHTML=e+1)),n&&(c||function(){c=n.parentNode,c.style.display="none"}(),l.appendChild(n))}),(s.children||s.childNodes)&&h.appendChild(s),(l.children||l.childNodes)&&c.appendChild(l),h.style.display="",c.style.display="",s=null,l=null,h=null,c=null},resize:function(){var e=t(".view",this.render),r=t("table",e);r.eq(1).parent().css({height:r.get(3).parentNode.clientHeight}),e.eq(1).css({width:this.render.clientWidth-1-e.get(0).offsetWidth})}},n.prototype.init.prototype=n.prototype,this.each(function(){var r=t(this),i=n(this,t.extend(!0,{},e)),a=r.data("ui");a?a.iDatagrid=i:r.data("ui",{iDatagrid:i})})}}(jQuery);