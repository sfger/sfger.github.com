!function(){"use strict";for(var t=["webkit","moz"],e=0;e<t.length&&!window.requestAnimationFrame;++e){var n=t[e];window.requestAnimationFrame=window[n+"RequestAnimationFrame"],window.cancelAnimationFrame=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"]}if(/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent)||!window.requestAnimationFrame||!window.cancelAnimationFrame){var r=0;window.requestAnimationFrame=function(t){var e=Date.now(),n=Math.max(r+16,e);return setTimeout(function(){t(r=n)},n-e)},window.cancelAnimationFrame=clearTimeout}}(),$.fn.datagrid=function(t){var e=$.type(t);if("string"===e){var n=Array.prototype.slice.call(arguments).slice(1),r=[];this.each(function(e){var i=$(e).data("ui");if(!i||!i.iDatagrid)throw new Error("UI:datagrid does not init...");r.push(i.iDatagrid[t].apply(i.iDatagrid,n))});var i=r.length;return 0===i?this:1===i?r[0]:r}t=$.extend(!0,{colWidth:80,startRowNum:1,data:[],sortable:!1,sort:null,dataType:"string",remoteSort:!1,autoRowHeight:!0,autoColWidth:!0,frozenColumns:[],columns:[]},t);var a=function(t,e){return new a.prototype.init(t,e)},o=Object.prototype.toString,s=function(t){return o.call(t).slice(8,-1)},l=function(t){var e="",n=[],r=null,i=null,a=l,o=s(t);if("Array"===o)for(var d in t)e+=a(t[d]);else if("String"===o||"Number"==o)e=t;else if("Object"===o&&t.name){if(r=t.attr,i=t.children,n=[],r)for(var c in r){if("style"==c){var h=r[c],u=s(h);if(r[c]="","Object"==u)for(var f in h)r[c]+=f+":"+h[f]+";";else"String"==u&&(r[c]=h)}n.push(""+c+'="'+r[c]+'"')}n.length&&n.unshift(""),i&&"Array"!==s(i)&&(i=[i]),e="<"+t.name+n.join(" ")+">"+(i?a(i):"")+"</"+t.name+">"}else e="";return e},d=function(t,e){var n=function(n,r){if(!n||r&&!t.frozenColumns.length)return[];var i=r?"frozenColumns":"columns",a=n.length-1;return n.map(function(n,o){return l({name:"tr",children:function(){var s=n.map(function(n){var r=n.name||n.field||"",s=t.autoColWidth||n.colspan?"auto":(n.width||t.colWidth)+"px",d={};n.rowspan&&(d.rowspan=n.rowspan),n.colspan&&(d.colspan=n.colspan);var c=n.colspan||1,h=1==c&&(o==a||a+1==o+(n.rowspan||1)),u={"class":"cell",style:{width:s}};if(h){e[i].push(n);var f=["field"];(t.sortable&&n.sortable!==!1||1==n.sortable)&&f.push("sortable"),d["class"]=f.join(" "),u["data-field"]=n.field}return l({name:"td",attr:d,children:{name:"div",attr:{"class":"cell-wrapper"},children:{name:"div",attr:u,children:[" ",{name:"span",attr:{"class":"field-title"},children:r},{name:"span",attr:{"class":"sort-mark"}}," "]}}})});return(t.frozenColumns.length&&r&&0===o&&t.rowNum||!t.frozenColumns.length&&0===o&&t.rowNum)&&s.unshift(l({name:"td",attr:{rowspan:t.frozenColumns.length||t.columns.length,"class":"field"},children:{name:"div",attr:{"class":"cell-wrapper"},children:{name:"div",attr:{"class":"cell"}}}})),s}()})})},r=function(e,n,r){return r&&!t.frozenColumns.length?[]:e.map(function(e,i){return l({name:"tr",children:function(){var a=[];return t.frozenColumns.length&&r&&t.rowNum&&a.push(l({name:"td",children:{name:"div",attr:{"class":"cell-wrapper"},children:{name:"div",attr:{"class":"cell"},children:i+t.startRowNum}}})),n&&n.forEach(function(n){if(!n)return!0;var r=n.field,i=e[r],o=n.formatter,s=["cell"],d={left:"txt-lt",right:"txt-rt"}[n.align]||"";d&&s.push(d),a.push(l({name:"td",children:{name:"div",attr:{"class":"cell-wrapper"},children:{name:"div",attr:{"class":s.join(" "),style:{width:t.autoColWidth?"auto":(n.width||t.colWidth)+"px"}},children:"function"===$.type(o)?o(i,e,r):i}}}))}),a}()})})};return l({name:"div",attr:{"class":"view-wrapper"+(t.autoRowHeight?" autoRowHeight":"")},children:[{name:"div",attr:{"class":"view frozen-view"},children:[{name:"div",attr:{"class":"head-wrapper"},children:{name:"table",attr:{"class":"frozen head"},children:{name:"tbody",children:n(t.frozenColumns,!0)}}},{name:"div",attr:{"class":"body-wrapper",style:"overflow:hidden;"},children:{name:"table",attr:{"class":"frozen body"},children:{name:"tbody",children:r(t.data,e.frozenColumns,!0)}}}]},{name:"div",attr:{"class":"view auto-view"},children:[{name:"div",attr:{style:"overflow:hidden"},children:{name:"div",attr:{"class":"head-wrapper"},children:{name:"table",attr:{"class":"head"},children:{name:"tbody",children:n(t.columns)}}}},{name:"div",attr:{"class":"body-wrapper"},children:{name:"table",attr:{"class":"body"},children:{name:"tbody",children:r(t.data,e.columns)}}}]}]})},c=function(t,e){return document.documentMode<7||/MSIE 6/.test(navigator.userAgent)?t["offset"+("width"==e?"Width":"Height")]:$(t)[e]()},h=function(t,e,n){var r="width"===n?"Width":"Height";$(t).each(function(t){var i=this["offset"+r],a=e[t]["offset"+r],o=i<a?a:i;$([this,e[t]])[n](o)})},u=function(t,e,n){$.each(t,function(t){var r=n[t],i=c(this,e),a=c(r,e);if(i!==a){var o=i<a?a:i;$([this,r])[e](o+3)}})},f=function(t,e){if(4==t.length){var n=t.eq(2).parent(),r=t.eq(3).parent();n.css({width:5e5}),r.css({width:5e5});var i=e.userOptions;u(t.filter("table:odd").find("tr:first-child td .cell"),"width",e.fieldElements),(i.rowNum||i.frozenColumns)&&(i.autoRowHeight&&u($("table:eq(1) td:first-child"),"height",$("table:eq(3) td:first-child")),h($([t[0],t[1]]),$([t[2],t[3]]),"height"),h($([t[0],t[2]]),$([t[1],t[3]]),"width"));var a="auto";r.css({width:a}),n.parent().css({width:a,overflow:"hidden"});var o=function(){n.parent().get(0).scrollLeft=this.scrollLeft,t.get(1).parentNode.scrollTop=this.scrollTop},s=null;$(r).off("scroll").on("scroll",function(){cancelAnimationFrame(s),s=requestAnimationFrame(o.bind(this))})}};return a.prototype={defaultOrder:!1,init:function(t,e){$(t).addClass("datagrid-ctn cf"),this.render=t,this.update(e),this.init_event(),this.reAlign(),this.resize(),e.onCreate.bind(this)()},update:function(t){var e=this,n=this.render;t=$.extend(!0,{},this.userOptions,t),$(n).empty(),this.columns=[],this.frozenColumns=[],this.userOptions=t,$(d(t,e)).prependTo(n),this.fieldElements=$(".field .cell",n),this.allColumns=[].concat(this.frozenColumns,this.columns),this.dataTbodys=$(".body tbody",n),t.data.forEach(function(n,r){t.frozenColumns.length&&(n.frozenTr=e.dataTbodys[0].rows[r]),n.tr=e.dataTbodys[1].rows[r]});var r=t.sort;if(t.remoteSort){var i=~[!0,"desc"].indexOf(r.order)?"desc":"asc";$(".head-wrapper [data-field="+r.field+"] .sort-mark",n).addClass(i)}else t.sort&&this.sortBy({field:r.field,order:r.order});return this.resize()},reAlign:function(){return f($("table",this.render),this),this},resize:function(){var t=this.render,e=$(".view",t),n=$("table",e);return n.eq(1).parent().css({height:n.get(3).parentNode.clientHeight}),e.eq(1).css({width:t.clientWidth-1-e.get(0).offsetWidth}),e.eq(1).css({width:t.clientWidth-1-e.get(0).offsetWidth}),this},init_event:function(){var t=this,e=this.userOptions,n=$(this.render);$(window).on("resize",function(){t.resize()}),e.remoteSort||n.on("click",".field.sortable",function(){var e=$(".cell",this).get(0);t.sortBy({field:$(e).data("field"),order:!e.order||t.defaultOrder},e)})},sortType:{string:function(t,e){var n=this.field,r=t[n],i=e[n];return r==i?0:r>i?1:-1},number:function(t,e){var n=this.field;return t[n]-e[n]}},getFieldOption:function(t){return this.allColumns.filter(function(e){return e.field===t})[0]},getColumnSortFunction:function(t){var e=this.getFieldOption(t.field),n=e.dataType||this.userOptions.dataType||"string",r=e.sort||this.sortType[n];return function(e,n){return r.call(t,e,n)*(t.order?-1:1)}},sortBy:function(t,e){var n=this.userOptions,r=this.sortElement;if(t.order=!!~[!0,"desc"].indexOf(t.order),this.sortElement=e=e||$(".head-wrapper [data-field="+t.field+"]",this.render).get(0),r){if(e===r){if(t.order===r.order)return this;n.data=n.data.reverse()}$(".sort-mark",r).removeClass("asc desc")}return $(".sort-mark",e).addClass(t.order?"desc":"asc"),n.data.sort(this.getColumnSortFunction(t)),e.order=t.order,e.field=t.field,this.sort_table_dom(n)},sort_table_dom:function(t){var e=document.createDocumentFragment(),n=document.createDocumentFragment(),r=null,i=null;return t.data.forEach(function(a,o){var s=a.frozenTr,l=a.tr;s&&(r||function(){r=s.parentNode,r.style.display="none"}(),e.appendChild(s),t.rowNum&&$("td:eq(0) .cell",s).text(o+1)),l&&(i||function(){i=l.parentNode,i.style.display="none"}(),n.appendChild(l))}),r&&(e.children||e.childNodes)&&(r.appendChild(e),r.style.display=""),i&&(n.children||n.childNodes)&&(i.appendChild(n),i.style.display=""),e=null,n=null,r=null,i=null,this}},a.prototype.init.prototype=a.prototype,this.each(function(){var e=$(this),n=a(this,$.extend(!0,{},t)),r=e.data("ui");r?r.iDatagrid=n:e.data("ui",{iDatagrid:n})})};