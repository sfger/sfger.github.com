!function(){"use strict";for(var t=["webkit","moz"],e=0;e<t.length&&!window.requestAnimationFrame;++e){var n=t[e];window.requestAnimationFrame=window[n+"RequestAnimationFrame"],window.cancelAnimationFrame=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"]}if(/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent)||!window.requestAnimationFrame||!window.cancelAnimationFrame){var r=0;window.requestAnimationFrame=function(t){var e=Date.now(),n=Math.max(r+16,e);return setTimeout(function(){t(r=n)},n-e)},window.cancelAnimationFrame=clearTimeout}}(),$.fn.datagrid=function(t){var e=$.type(t);if("string"===e){for(var n=Array.prototype.slice.call(arguments).slice(1),r=[],i=0,a=this.length;a>i;i++){var o=$(this[i]).data("ui");if(!o||!o.iDatagrid)throw new Error("UI:datagrid does not init...");r.push(o.iDatagrid[t].apply(o.iDatagrid,n))}var s=r.length;return 0===s?this:1===s?r[0]:r}t=$.extend(!0,{colWidth:80,startRowNum:1,data:[]},t);var d=function(t,e){return new d.prototype.init(t,e)},l={up:"↑",down:"↓",empty:"&nbsp;"},c=Array.prototype.push,h=Object.prototype.toString,u=function(t){return h.call(t).slice(8,-1)},f=function(t){var e="",n=[],r=null,i=null,a=f,o=u(t);if("Array"===o)for(var s in t)e+=a(t[s]);else if("String"===o||"Number"==o)e=t;else if("Object"===o&&t.name){if(r=t.attr,i=t.children,n=[],r)for(var d in r){if("style"==d){var l=r[d],c=u(l);if(r[d]="","Object"==c)for(var h in l)r[d]+=h+":"+l[h]+";";else"String"==c&&(r[d]=l)}n.push(""+d+'="'+r[d]+'"')}n.length&&n.unshift(""),i&&"Array"!==u(i)&&(i=[i]),e="<"+t.name+n.join(" ")+">"+(i?a(i):"")+"</"+t.name+">"}else e="";return e},m=function(t,e){var n=function(n,r){var i=[],a=r?"frozenColumns":"columns";if(!n)return i;for(var o=n.length-1,s=o;s>=0;s--)i.unshift(f({name:"tr",children:function(){for(var i=[],d=n[s].length-1;d>=0;d--){var c=n[s][d],h=c.name||c.field||"",u=t.autoColWidth||c.colspan?"auto":(c.width||t.colWidth)+"px",m={};c.rowspan&&(m.rowspan=c.rowspan),c.colspan&&(m.colspan=c.colspan);var p=c.colspan||1,w=1==p&&(s==o||n.length==s+(c.rowspan||1));w&&(e[a].unshift(c),m["class"]="field"),i.unshift(f({name:"td",attr:m,children:{name:"div",attr:{"class":"cell",style:{width:u},"data-field":c.field},children:[l.empty,{name:"span",attr:{"class":"field-title"},children:h},{name:"span",attr:{"class":"sort-mark"}},l.empty]}}))}return r&&0===s&&t.rowNum&&i.unshift(f({name:"td",attr:{rowspan:t.frozenColumns.length,"class":"field"},children:{name:"div",attr:{"class":"cell"}}})),i}()}));return i},r=function(e,n,r){var i=[];return e.forEach(function(e,a){i.push(f({name:"tr",children:function(){var i=[];return t.rowNum&&r&&i.push(f({name:"td",children:{name:"div",attr:{"class":"cell"},children:a+t.startRowNum}})),n&&n.forEach(function(n){if(!n)return!0;var r=n.field,a=e[r],o=n.formatter;i.push(f({name:"td",children:{name:"div",attr:{"class":"cell",style:{width:t.autoColWidth?"auto":(n.width||t.colWidth)+"px"}},children:"function"===$.type(o)?o(a,e,r):a}}))}),i}()}))}),i};return f({name:"div",attr:{"class":"view-wrapper"+(t.autoRowHeight?" autoRowHeight":"")},children:[{name:"div",attr:{"class":"view frozen"},children:[{name:"div",attr:{"class":"head-wrapper"},children:{name:"table",attr:{"class":"frozen head"},children:{name:"tbody",children:n(t.frozenColumns,!0)}}},{name:"div",attr:{"class":"body-wrapper",style:"overflow:hidden;"},children:{name:"table",attr:{"class":"frozen body"},children:{name:"tbody",children:r(t.data,e.frozenColumns,!0)}}}]},{name:"div",attr:{"class":"view"},children:[{name:"div",attr:{style:"overflow:hidden"},children:{name:"div",attr:{"class":"head-wrapper"},children:{name:"table",attr:{"class":"head"},children:{name:"tbody",children:n(t.columns)}}}},{name:"div",attr:{"class":"body-wrapper"},children:{name:"table",attr:{"class":"body"},children:{name:"tbody",children:r(t.data,e.columns)}}}]}]})},p=function(t,e){return document.documentMode<7||/MSIE 6/.test(navigator.userAgent)?t["offset"+("width"==e?"Width":"Height")]:$(t)[e]()},w=function(t,e,n){var r="width"===n?"Width":"Height";$(t).each(function(t){var i=this["offset"+r],a=e[t]["offset"+r],o=a>i?a:i;$([this,e[t]])[n](o)})},v=function(t,e,n){$.each(t,function(t){var r=n[t],i=p(this,e),a=p(r,e);if(i!==a){var o=a>i?a:i;$([this,r])[e](o+5)}})},y=function(t,e){if(4==t.length){var n=t.eq(2).parent(),r=t.eq(3).parent();n.css({width:5e5}),r.css({width:5e5});var i=e.userOptions;(i.rowNum||i.frozenColumns)&&w($([t[0],t[1]]),$([t[2],t[3]]),"height"),i.autoColWidth?v(t.filter("table:odd").find("tr:first-child td .cell"),"width",e.fieldElements):i.rowNum&&v(t.filter("table:odd").find("td .cell:first"),"width",e.fieldElements),(i.rowNum||i.frozenColumns)&&w($([t[0],t[2]]),$([t[1],t[3]]),"width",e.fieldElements);var a="CSS1Compat"!==document.compatMode||/msie 6/i.test(navigator.userAgent)?"100%":"auto";r.css({width:a}),n.parent().css({width:a,overflow:"hidden"});var o=function(){n.parent().get(0).scrollLeft=this.scrollLeft,t.get(1).parentNode.scrollTop=this.scrollTop},s=null;$(r).on("scroll",function(){cancelAnimationFrame(s),s=requestAnimationFrame(o.bind(this))})}},g=function(t,e){var n=this.field,r=this.order?-1:1;return t[n]==e[n]?0:r*(t[n]>e[n]?1:-1)};return d.prototype={defaultOrder:!1,init:function(t,e){var n=$(t);n.addClass("datagrid-ctn cf"),this.render=t,this.update(e),this.init_event(),this.fix_size(),e.onCreate.bind(this)()},update:function(t){var e=this,n=this.render,r=$(n);t=$.extend(!0,{},this.userOptions,t),r.empty(),this.columns=[],this.frozenColumns=[],this.userOptions=t,$(m(t,e)).prependTo(n),this.fieldElements=$(".field .cell",n),y($("table",n),e),function(){var t=navigator.userAgent.match(/MSIE (\d*)/);t&&t[1]<9&&$(".view",n).eq(1).find("table, table td:first-child").css({borderLeft:"none"})}();var i=[];c.apply(i,this.frozenColumns),c.apply(i,this.columns),this.allColumns=i,this.dataTbodys=$(".body tbody",n),t.data.forEach(function(n,r){t.frozenColumns.length&&(n.frozenTr=e.dataTbodys[0].rows[r]),n.tr=e.dataTbodys[1].rows[r]});var a=t.sort;if(t.remoteSort){var o=-1===[!0,"desc"].indexOf(a.order)?"asc":"desc";$(".head-wrapper [data-field="+a.field+"] .sort-mark",n).addClass(o)}else t.sort&&this.sortBy({field:a.field,order:a.order});return this.fix_size(),!0},fix_size:function(){var t=this;t.resize(),setTimeout(function(){t.resize()},0)},resize:function(){var t=$(".view",this.render),e=$("table",t);e.eq(1).parent().css({height:e.get(3).parentNode.clientHeight}),t.eq(1).css({width:this.render.clientWidth-1-t.get(0).offsetWidth})},init_event:function(){var t=this,e=this.userOptions,n=$(this.render);$(window).on("resize",function(){t.resize()}),e.remoteSort||n.on("click",".field .cell",function(){t.sortBy({field:$(this).data("field"),order:!this.order||this.defaultOrder})})},getColumnOption:function(t){return this.allColumns.filter(function(e){return e.field===t})[0]},getColumnSortFunction:function(t){return this.getColumnOption(t).sort||g},sortBy:function(t){t.order=-1!==[!0,"desc"].indexOf(t.order);var e=$(".head-wrapper [data-field="+t.field+"]",this.render).get(0),n=this.sortElement,r=this.userOptions;if(this.sortElement=e,n){if(e===n){if(t.order===n.order)return!1;r.data=r.data.reverse()}$(".sort-mark",n).removeClass("asc desc")}$(".sort-mark",e).addClass(t.order?"desc":"asc"),r.data.sort(this.getColumnSortFunction(t.field).bind(t)),e.order=t.order,e.field=t.field;var i=document.createDocumentFragment(),a=document.createDocumentFragment(),o=null,s=null;return r.data.forEach(function(t,e){var n=t.frozenTr,d=t.tr;n&&(o||function(){o=n.parentNode,o.style.display="none"}(),i.appendChild(n),r.rowNum&&$("td:eq(0) .cell",n).text(e+1)),d&&(s||function(){s=d.parentNode,s.style.display="none"}(),a.appendChild(d))}),(i.children||i.childNodes)&&(o.appendChild(i),o.style.display=""),(a.children||a.childNodes)&&(s.appendChild(a),s.style.display=""),i=null,a=null,o=null,s=null,!0}},d.prototype.init.prototype=d.prototype,this.each(function(){var e=$(this),n=d(this,$.extend(!0,{},t)),r=e.data("ui");r?r.iDatagrid=n:e.data("ui",{iDatagrid:n})})};