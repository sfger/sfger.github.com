!function(e,t){e.fn.tree=function(t){var n=e.type(t);if("string"===n){var i=Array.prototype.slice.call(arguments).slice(1),o=[];return this.each(function(){var n=e(this).data("ui");if(!n||!n.iTree)throw new Error("UI:tree does not init...");o.push(n.iTree[t].apply(n.iTree,i))}),"isLeaf"==t?o[0]:this}t=e.extend(!0,{animate:{time:0},data:[]},t);var r=function(e,t){return new r.prototype.init(e,t)},a=function(e,n,i,o,r){n||(n=1),r||(i.innerHTML='<ul data-deep="1"><li class="line" style="display:block;"><a href="javascript:" style="display:none;"><span class="title">__ROOT__</span></a></li></ul>',i=i.children[0].children[0],i.children[0].option={name:"__ROOT__",children:e});var d=document.createElement("ul");d.setAttribute("data-deep",n);for(var s=0,l=e.length-1;l>=s;s++){var c=document.createElement("span"),p=document.createElement("li"),h=document.createElement("a");d.appendChild(p),d.setAttribute("data-deep",n),p.appendChild(h),h.setAttribute("href","javascript:"),h.className="line",h.option=e[s];for(var u=e[s].children?1==n?n-2:n-1:n,m=0;u>m;m++){var f=document.createElement("span");h.appendChild(f),f.className=m===u-1?"join":"indent"}var g=document.createElement("span");if(g.className="file",h.appendChild(g),e[s].children){var v=document.createElement("span");h.appendChild(v),v.className="hit",g.className="folder",a(e[s].children,n+1,p,o,!0)}else o.push(d);if(t.checkbox){var b=document.createElement("span");b.className="checkbox"+(e[s].checked?" checkbox-all":""),h.appendChild(b)}h.appendChild(c),c.appendChild(document.createTextNode(e[s].name)),c.className="title"}i.appendChild(d)};return r.prototype={init:function(t,n){var i=this,o=window.document;["Height","Width"].forEach(function(e){i["getView"+e]=function(){var t="BackCompat"===o.compatMode?o.body:o.documentElement;return function(){return t["client"+e]}}(),i["getElement"+e]=function(t){return t&&"none"!==t.style.display?t["offset"+e]:0}});var r=[];a(n.data,1,t,r);var d=e(t.children[0]),s=e(t);if(s.addClass("tree-container"),this.userOptions=n,this.container=s.get(0),this.contents=d.get(0),e(this.contents).delegate("a",{contextmenu:function(e){return i.userOptions.onContextmenu?i.userOptions.onContextmenu.bind(this)(e):void 0},click:function(t){return i.isLeaf(this)?(e(i.currentElement).removeClass("current"),i.currentElement=this,e(this).addClass("current")):i.toggle(this),i.userOptions.onClick.bind(this)(t)}}),n.checkbox){var l={updateChildCheckState:function(t,n){if(t){var i=t.children,o=i.length;if(i&&o--)for(var r=0;o>=r;r++){var a=i[r],d=a.children[0],s=e(".checkbox",d);s.get(0).className="checkbox",n&&s.addClass("checkbox-all"),d.option.checked=n,l.updateChildCheckState(a.children[1],n)}}},updateParentCheckState:function(t){if(t&&!(t.getAttribute("data-deep")<2)&&"ul"===t.nodeName.toLowerCase()){var n=t.parentNode,i=t.children.length,o=e(">li>a>.checkbox-all",t).length,r=e(".checkbox",n).get(0);if(o&&o===i)r.className="checkbox checkbox-all";else{var a=e(">li>a>.checkbox-some",t).length;a||o?r.className="checkbox checkbox-some":r.className="checkbox"}l.updateParentCheckState(n.parentNode)}}};e(this.contents).delegate(".checkbox",{click:function(){var e=this.parentNode,t=e.parentNode;return l.updateChildCheckState({children:[t]},!e.option.checked),e.parentNode.parentNode.getAttribute("data-deep")>1&&l.updateParentCheckState(t.parentNode),!1}}),e.each(r,function(e,t){l.updateParentCheckState(t)})}if(n.dnd){var c={updatePosition:function(t){e(i.dragingProxyElement).css({top:t.pageY,left:t.pageX+25})},start:function(){e(o).on({mousemove:c.move,mouseup:c.end})},move:function(t){i.disableSelection(),"block"!==i.dragingProxyElement.style.display&&(i.dragingProxyElement.style.display="block"),c.updatePosition(t);var n,r=o.elementFromPoint(t.pageX,t.pageY);if(c.dropPosition=null,r&&(e(r).hasClass("line")?n=r:e(r.parentNode).hasClass("line")&&(n=r.parentNode),c.prevLine&&e(c.prevLine).css({border:"",boxSizing:""}),n&&n!=i.dragingElement&&!e.contains(i.dragingElement.parentNode,n))){var a=n.offsetHeight,d=e(n),s=d.position();if(c.prevLine=n,d.css({border:"none"}),t.pageY-s.top<5)d.css({borderTop:"1px dotted red",boxSizing:"border-box"}),c.dropPosition="before";else if(a+s.top-t.pageY<5)d.css({borderBottom:"1px dotted red",boxSizing:"border-box"}),c.dropPosition="after";else{if(i.isLeaf(n))return;d.css({border:"1px dotted red",boxSizing:"border-box"}),c.dropPosition="append"}}},updateChildrenIndext:function(e,t){if(e){var n;n=!e.nodeName||e.nodeType?e.children[0].parentNode:e,n.setAttribute("data-deep",Number(n.parentNode.parentNode.getAttribute("data-deep"))+1);var i=e.children,r=e.children.length,a=t;if(i&&r--){var d=o.createElement("span");d.className="indent";for(var s=0;r>=s;s++){var l=i[s],p=l.children[0];if(a=t,a>=0)for("append"==c.dropPosition&&a++;a--;)p.insertBefore(d.cloneNode(!0),p.children[0]);else for(a=-a,"append"==c.dropPosition&&a--;a--;)p.removeChild(p.children[a]);c.updateChildrenIndext(p.nextSibling,t)}}}},end:function(){if(e(i.dragingProxyElement).hide(),e(c.prevLine).css({border:"none"}),e(o).off({mousemove:c.move,mouseup:c.end}),c.dropPosition){if(n.onBeforeDrop){var t=n.onBeforeDrop.bind(i)(c.prevLine,i.dragingElement,c.dropPosition);if(t===!1)return}var r=i.dragingElement.parentNode,a=c.prevLine.parentNode,d=r.parentNode,s=a.parentNode.getAttribute("data-deep")-r.parentNode.getAttribute("data-deep"),p=e(r).index(),h=i.getParentNode(r).option.children,u=h[p];if(h.splice(p,1),"append"===c.dropPosition){if(i.isLeaf(c.prevLine))return;c.prevLine.nextSibling.appendChild(r),c.prevLine.option.children.push(u)}else{var m;a.parentNode===r.parentNode?(m=e(a).index()-(e(a).index()>p)+("after"===c.dropPosition),i.getParentNode(a).option.children.splice(m,0,u)):(m=e(a).index()+("after"===c.dropPosition),i.getParentNode(a).option.children.splice(m,0,u)),e(a)[c.dropPosition](r)}c.updateChildrenIndext({children:[r]},s),c.dropPosition=null,n.checkbox&&(r&&l.updateParentCheckState(r.parentNode),d&&l.updateParentCheckState(d),a&&l.updateParentCheckState(a.parentNode)),n.onDrop&&n.onDrop.bind(i)(c.prevLine,i.dragingElement,c.dropPosition)}}};/Chrome/.test(navigator.userAgent)&&e(this.contents).delegate("a",{mouseenter:function(){e(this).addClass("hover")},mouseleave:function(){e(this).removeClass("hover")}}),e(this.contents).delegate("a",{mousedown:function(t){return i.dragingElement=this,i.dragingProxyElement||(i.dragingProxyElement=o.createElement("div"),o.body.appendChild(i.dragingProxyElement),e(i.dragingProxyElement).addClass("tree-draging-proxy")),e(i.dragingProxyElement).html(i.dragingElement.option.name),c.updatePosition(t),c.start(),!1}})}},getParentNode:function(e){var t=null;try{t=e.parentNode.parentNode.children[0]}catch(n){}return t},disableSelection:function(){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},isLeaf:function(e){return!e.option.children},toggle:function(t){return this[e(t.nextSibling).is(":visible")?"collapse":"expand"](t),this},expand:function(t){var n="show";return e(t.parentNode).addClass("expanded").find(">a>.hit").addClass("hit-open"),e(t.nextSibling)[n](this.userOptions.animate.time),this},collapse:function(t){var n="hide";return e(t.parentNode).removeClass("expanded").find(">a>.hit").removeClass("hit-open"),e(t.nextSibling)[n](this.userOptions.animate.time),this}},r.prototype.init.prototype=r.prototype,this.each(function(){var n=e(this),i=r(this,e.extend(!0,{},t)),o=n.data("ui");o?o.iTree=i:n.data("ui",{iTree:i})})}}(jQuery);